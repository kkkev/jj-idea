name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version calculation

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Calculate version
        id: version
        run: |
          # Use run number for patch version: 0.1.{run_number}
          VERSION="0.1.${{ github.run_number }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Calculated version: ${VERSION}"

      - name: Update version in build.gradle.kts
        run: |
          sed -i 's/^version = .*/version = "${{ steps.version.outputs.version }}"/' build.gradle.kts
          cat build.gradle.kts | grep '^version'

      - name: Build plugin
        run: ./gradlew buildPlugin

      - name: Run tests
        run: ./gradlew simpleTest

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-artifact
          path: build/distributions/*.zip
          retention-days: 30

      # Only create release on push to main/master (not on PRs)
      - name: Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            Automated release of version ${{ steps.version.outputs.version }}

            Commit: ${{ github.sha }}
          files: build/distributions/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update plugin repository XML
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${{ steps.version.outputs.tag }}"
          PLUGIN_FILE="jj-idea-${VERSION}.zip"

          cat > updatePlugins.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <plugins>
            <plugin id="in.kkkev.jj-idea" url="https://github.com/kkkev/jj-idea/releases/download/${TAG_NAME}/${PLUGIN_FILE}" version="${VERSION}">
              <idea-version since-build="251.0" />
              <name>Jujutsu VCS Integration</name>
              <description><![CDATA[
                Native integration with Jujutsu (jj) version control system.

                Features:
                - JJ-native workflow tool window (left side)
                - Describe-first workflow support
                - Continuous commit workflow
                - Working copy status and diffs
                - Commands: jj describe, jj new
              ]]></description>
              <vendor email="jj-idea@kkkev.in" url="https://github.com/kkkev/jj-idea">Kevin Thomas</vendor>
              <change-notes><![CDATA[
                <h3>${VERSION}</h3>
                <p>See <a href="https://github.com/kkkev/jj-idea/releases/tag/${TAG_NAME}">release notes</a> for details.</p>
              ]]></change-notes>
            </plugin>
          </plugins>
          EOF

      - name: Commit updated plugin repository XML
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add updatePlugins.xml
          git commit -m "Update plugin repository for release ${TAG_NAME}" || echo "No changes to commit"
          git push origin ${{ github.ref_name }}

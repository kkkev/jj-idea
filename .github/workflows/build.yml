name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        type: choice
        options:
          - '' # snapshot build (default)
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  changelog-check:
    # Check that changelog is updated when source code changes
    # Skip for: tags, workflow_dispatch releases, [skip changelog] in commit message, or no source changes
    if: ${{ !startsWith(github.ref, 'refs/tags/') && inputs.bump == '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for skip changelog flag
        id: skip-check
        run: |
          # Check commit message for [skip changelog]
          if git log --format=%B -n 1 ${{ github.sha }} | grep -qi '\[skip changelog\]'; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping changelog check: [skip changelog] found in commit message"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check changelog updated
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          # Get the base ref for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
          else
            BASE_SHA=${{ github.event.before }}
          fi

          # Check if source code changed
          SOURCE_CHANGED=$(git diff --name-only $BASE_SHA ${{ github.sha }} -- 'src/main/**' | head -1)

          if [ -n "$SOURCE_CHANGED" ]; then
            echo "Source code changed, checking changelog..."

            # Check if CHANGELOG.md was updated
            CHANGELOG_CHANGED=$(git diff --name-only $BASE_SHA ${{ github.sha }} -- 'CHANGELOG.md' | head -1)

            if [ -z "$CHANGELOG_CHANGED" ]; then
              echo "::error::Source code changed but CHANGELOG.md was not updated."
              echo "::error::Please add an entry to the [Unreleased] section of CHANGELOG.md."
              echo "::error::If this change doesn't need a changelog entry (refactoring, tests, etc.),"
              echo "::error::add [skip changelog] to your commit message."
              exit 1
            else
              echo "Changelog was updated. Check passed."
            fi
          else
            echo "No source code changes detected. Skipping changelog check."
          fi

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version calculation

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Calculate version
        id: version
        run: |
          if [[ -n "${{ inputs.bump }}" ]]; then
            # Manual release via workflow_dispatch - calculate next version
            # Get latest version tag
            LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -1)
            if [[ -z "$LATEST_TAG" ]]; then
              LATEST_TAG="v0.0.0"
            fi
            # Parse version components
            LATEST_VERSION=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"

            # Bump based on input
            case "${{ inputs.bump }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            VERSION="${MAJOR}.${MINOR}.${PATCH}"
            IS_RELEASE=true
            echo "Bumping from ${LATEST_VERSION} to ${VERSION} (${{ inputs.bump }})"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            # Tagged release: use tag version (e.g., v0.2.0 -> 0.2.0)
            VERSION=${GITHUB_REF#refs/tags/v}
            IS_RELEASE=true
          else
            # Development build: use snapshot version based on latest tag
            LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -1)
            LATEST_VERSION=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
            VERSION="${MAJOR}.${MINOR}.${{ github.run_number }}-SNAPSHOT"
            IS_RELEASE=false
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          echo "Calculated version: ${VERSION} (release: ${IS_RELEASE})"

      - name: Update version in build.gradle.kts
        run: |
          sed -i 's/^version = .*/version = "${{ steps.version.outputs.version }}"/' build.gradle.kts
          cat build.gradle.kts | grep '^version'

      - name: Build plugin
        run: ./gradlew buildPlugin

      - name: Check (test + lint)
        run: ./gradlew check

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-artifact
          path: build/distributions/*.zip
          retention-days: 30

      - name: Extract changelog for release
        if: steps.version.outputs.is_release == 'true'
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Extract section between ## [X.Y.Z] and next ## [ or link reference section
          # Uses awk to find the version section, skip header, stop before next section or links
          NOTES=$(awk "
            /^## \[${VERSION}\]/ { found=1; next }
            found && /^## \[/ { exit }
            found && /^\[.+\]:/ { exit }
            found { print }
          " CHANGELOG.md)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Create release (from tag push or workflow_dispatch)
      - name: Create GitHub Release
        if: steps.version.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          files: build/distributions/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update plugin repository XML
        if: steps.version.outputs.is_release == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG_NAME: ${{ steps.version.outputs.tag }}
          CHANGE_NOTES: ${{ steps.changelog.outputs.notes }}
        run: |
          PLUGIN_FILE="jj-idea-${VERSION}.zip"

          # Convert markdown to basic HTML (safely via env var)
          CHANGE_NOTES_HTML=$(echo "$CHANGE_NOTES" | sed 's/^### \(.*\)$/<h4>\1<\/h4>/g' | sed 's/^- \(.*\)$/<li>\1<\/li>/g' | sed 's/^$//g')

          cat > updatePlugins.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <plugins>
            <plugin id="in.kkkev.jj-idea" url="https://github.com/kkkev/jj-idea/releases/download/${TAG_NAME}/${PLUGIN_FILE}" version="${VERSION}">
              <idea-version since-build="251.0" />
              <name>Jujutsu VCS Integration</name>
              <description><![CDATA[
                <p>Native IntelliJ integration for <a href="https://jj-vcs.github.io/jj/">Jujutsu (jj)</a>, a Git-compatible version control system with a fundamentally different approach to working with code.</p>

                <h3>Why Jujutsu?</h3>
                <p>Jujutsu treats your working copy as a commit—always. No staging area, no "dirty" state. Just describe what you're working on and keep coding.</p>

                <h3>Key Features</h3>
                <ul>
                    <li><b>Describe-First Workflow</b> — Working Copy tool window for describing current work and creating new changes.</li>
                    <li><b>Custom Log View</b> — Visual commit graph with inline change IDs, descriptions, and bookmarks.</li>
                    <li><b>Change Operations</b> — Edit, abandon, and describe changes directly from the log.</li>
                    <li><b>File History &amp; Annotations</b> — Full file history with diff viewer and line-by-line blame.</li>
                    <li><b>Multi-Repository Support</b> — Work with multiple JJ repositories in a single project.</li>
                    <li><b>Real-Time Status</b> — Auto-refresh keeps the UI in sync as you edit files.</li>
                </ul>

                <p><a href="https://github.com/kkkev/jj-idea">GitHub</a> · <a href="https://github.com/kkkev/jj-idea/issues">Issues</a></p>
              ]]></description>
              <vendor email="jj-idea@kkkev.in" url="https://github.com/kkkev/jj-idea">Kevin Thomas</vendor>
              <change-notes><![CDATA[
                <h3>${VERSION}</h3>
                ${CHANGE_NOTES_HTML}
                <p>See <a href="https://github.com/kkkev/jj-idea/releases/tag/${TAG_NAME}">full release notes</a> for details.</p>
              ]]></change-notes>
            </plugin>
          </plugins>
          EOF

      - name: Commit updated plugin repository XML
        if: steps.version.outputs.is_release == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add updatePlugins.xml
          git commit -m "Update plugin repository for release ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin HEAD:${{ github.event.repository.default_branch }}

      # Publish to JetBrains Marketplace on releases
      # Requires PUBLISH_TOKEN secret from JetBrains Hub (hub.jetbrains.com → Profile → Tokens)
      # Optional: CERTIFICATE_CHAIN, PRIVATE_KEY, PRIVATE_KEY_PASSWORD for plugin signing
      - name: Publish to JetBrains Marketplace
        if: steps.version.outputs.is_release == 'true' && env.PUBLISH_TOKEN != ''
        env:
          PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
          CERTIFICATE_CHAIN: ${{ secrets.CERTIFICATE_CHAIN }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PRIVATE_KEY_PASSWORD: ${{ secrets.PRIVATE_KEY_PASSWORD }}
        run: ./gradlew publishPlugin
